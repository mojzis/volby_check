name: Publish Marimo Notebooks to GitHub Pages

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # Allow manual triggering

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dependencies
        run: |
          uv sync

      - name: Create output directory
        run: mkdir -p html_output

      - name: Export Marimo notebooks to HTML
        run: |
          # Export each Marimo notebook analysis file
          echo "Exporting suspicious_zeros_analysis.py..."
          uv run marimo export html suspicious_zeros_analysis.py -o html_output/suspicious_zeros_analysis.html

          echo "Exporting suspicious_zeros_with_obec_analysis.py..."
          uv run marimo export html suspicious_zeros_with_obec_analysis.py -o html_output/suspicious_zeros_with_obec_analysis.html

          echo "Exporting suspicious_zeros_obec_specific.py..."
          if [ -f "suspicious_zeros_obec_specific.py" ]; then
            uv run marimo export html suspicious_zeros_obec_specific.py -o html_output/suspicious_zeros_obec_specific.html
          fi

          echo "Exporting suspicious_cases_analysis.py..."
          uv run marimo export html suspicious_cases_analysis.py -o html_output/suspicious_cases_analysis.html

      - name: Create index page
        run: |
          cat > html_output/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Czech Election Analysis - Notebooks</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      max-width: 900px;
                      margin: 0 auto;
                      padding: 40px 20px;
                      background: #f5f5f5;
                      color: #333;
                  }
                  h1 {
                      color: #2c3e50;
                      border-bottom: 3px solid #3498db;
                      padding-bottom: 10px;
                  }
                  h2 {
                      color: #34495e;
                      margin-top: 30px;
                  }
                  .notebook-list {
                      background: white;
                      border-radius: 8px;
                      padding: 20px;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                  }
                  .notebook-item {
                      margin: 15px 0;
                      padding: 15px;
                      border-left: 4px solid #3498db;
                      background: #f8f9fa;
                      border-radius: 4px;
                  }
                  .notebook-item a {
                      color: #2980b9;
                      text-decoration: none;
                      font-weight: bold;
                      font-size: 1.1em;
                  }
                  .notebook-item a:hover {
                      color: #3498db;
                      text-decoration: underline;
                  }
                  .notebook-item p {
                      margin: 5px 0 0 0;
                      color: #666;
                  }
                  .recommended {
                      border-left-color: #27ae60;
                  }
                  .recommended::before {
                      content: "‚≠ê RECOMMENDED";
                      display: block;
                      color: #27ae60;
                      font-size: 0.8em;
                      font-weight: bold;
                      margin-bottom: 5px;
                  }
                  footer {
                      margin-top: 40px;
                      padding-top: 20px;
                      border-top: 1px solid #ddd;
                      text-align: center;
                      color: #666;
                      font-size: 0.9em;
                  }
              </style>
          </head>
          <body>
              <h1>Czech Election Analysis - Interactive Notebooks</h1>

              <p>Statistical analysis of suspicious zero-vote cases in Czech parliamentary elections using probability theory and geographic context.</p>

              <h2>Available Notebooks</h2>

              <div class="notebook-list">
                  <div class="notebook-item recommended">
                      <a href="suspicious_zeros_with_obec_analysis.html">Enhanced Analysis with Municipality Context</a>
                      <p>Complete analysis with municipality size adjustments - the most comprehensive view</p>
                  </div>

                  <div class="notebook-item">
                      <a href="suspicious_zeros_analysis.html">Basic Probability Analysis</a>
                      <p>Core statistical analysis of zero-vote cases using binomial probability</p>
                  </div>

                  <div class="notebook-item">
                      <a href="suspicious_cases_analysis.html">Additional Suspicious Cases</a>
                      <p>Extended analysis of suspicious voting patterns</p>
                  </div>
              </div>

              <h2>About This Analysis</h2>
              <p>This project identifies statistically improbable zero-vote cases where major political parties received no votes in specific voting commissions. The analysis uses:</p>
              <ul>
                  <li><strong>Binomial Probability:</strong> P(0 votes) = (1-p)^n</li>
                  <li><strong>Municipality Size Context:</strong> Adjusts for urban vs rural voting patterns</li>
                  <li><strong>Thresholds:</strong> P &lt; 0.1% = highly suspicious, P &lt; 1% = suspicious</li>
              </ul>

              <footer>
                  <p>Data source: Czech Statistical Office (CZSO) - <a href="https://www.volby.cz/opendata/">volby.cz/opendata</a></p>
                  <p>Generated with Marimo interactive notebooks</p>
              </footer>
          </body>
          </html>
          EOF

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: html_output

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
